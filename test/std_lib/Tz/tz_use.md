è¿™æ®µä»£ç æ˜¯ç”¨ **Zig è¯­è¨€** ç¼–å†™çš„ï¼Œç”¨äºè§£æ **æ—¶åŒºä¿¡æ¯æ–‡ä»¶æ ¼å¼ (TZif)** â€”â€” å³ Unix/Linux ç³»ç»Ÿä¸­å¸¸è§çš„ `.tz` æˆ– `/usr/share/zoneinfo/` ç›®å½•ä¸‹çš„äºŒè¿›åˆ¶æ—¶åŒºæ•°æ®æ–‡ä»¶ã€‚å®ƒéµå¾ª [RFC 8536](https://datatracker.ietf.org/doc/html/rfc8536) æ ‡å‡†æ—¶åŒºä¿¡æ¯æ ¼å¼è§„èŒƒã€‚

ä¸‹é¢æ˜¯å¯¹è¯¥ä»£ç çš„è¯¦ç»†è§£é‡Šï¼š

---

## ğŸ“š èƒŒæ™¯ï¼šä»€ä¹ˆæ˜¯ TZifï¼Ÿ

TZifï¼ˆTime Zone Information Formatï¼‰æ˜¯ä¸€ç§æ ‡å‡†çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œç”¨æ¥å­˜å‚¨ä¸€ä¸ªåœ°åŒºçš„æ—¶é—´å˜åŒ–è§„åˆ™ï¼ŒåŒ…æ‹¬ï¼š
- å†å²å’Œæœªæ¥çš„å¤ä»¤æ—¶ï¼ˆDSTï¼‰è½¬æ¢æ—¶é—´ç‚¹
- æ¯ä¸ªæ—¶é—´æ®µå¯¹åº”çš„ UTC åç§»é‡
- å¤ä»¤æ—¶æ ‡å¿—
- æ—¶åŒºç¼©å†™åç§°ï¼ˆå¦‚ `PDT`, `CET`ï¼‰
- é˜ˆå€¼ä¿®æ­£ï¼ˆleap secondsï¼‰

è¿™ç§æ ¼å¼è¢« `glibc`ã€`zic` ç¼–è¯‘å™¨ç­‰å¹¿æ³›ä½¿ç”¨ã€‚

---

## ğŸ” æ•´ä½“ç»“æ„æ¦‚è§ˆ

è¿™ä¸ªæ¨¡å—å®šä¹‰äº†ä¸€ä¸ª `Tz` ç»“æ„ä½“åŠå…¶ç›¸å…³ç±»å‹ï¼Œå¹¶æä¾›äº†è§£æ TZif æ–‡ä»¶çš„åŠŸèƒ½ã€‚

### ä¸»è¦ç»„æˆéƒ¨åˆ†ï¼š
```zig
pub const Tz = struct {
    allocator: Allocator,
    transitions: []const Transition,     // æ—¶é—´åˆ‡æ¢ç‚¹åˆ—è¡¨
    timetypes: []const Timetype,         // æ—¶é—´ç±»å‹ï¼ˆåç§»/DST/åç§°ï¼‰
    leapseconds: []const Leapsecond,     // é˜ˆå€¼ç§’è®°å½•
    footer: ?[]const u8,                 // å¯é€‰ POSIX TZ å­—ç¬¦ä¸²
};
```

---

## ğŸ§± æ•°æ®ç»“æ„è¯¦è§£

### 1. `Transition` - æ—¶é—´è½¬æ¢ç‚¹
```zig
pub const Transition = struct {
    ts: i64,           // UTC æ—¶é—´æˆ³ï¼ˆå•ä½ï¼šç§’ï¼‰ï¼Œè¡¨ç¤ºåœ¨æ­¤æ—¶é—´å‘ç”Ÿæ—¶åŒºå˜æ›´
    timetype: *Timetype // æŒ‡å‘ç”Ÿæ•ˆçš„ Timetype æè¿°
};
```
> ä¾‹å¦‚ï¼Œåœ¨æŸå¹´3æœˆç¬¬äºŒä¸ªå‘¨æ—¥çš„2AMï¼Œä»æ ‡å‡†æ—¶é—´åˆ‡æ¢åˆ°å¤ä»¤æ—¶ã€‚

---

### 2. `Timetype` - æ—¶é—´ç±»å‹æè¿°
```zig
pub const Timetype = struct {
    offset: i32,        // ä¸ UTC çš„åç§»ï¼ˆç§’ï¼‰ï¼Œå¦‚ +3600 è¡¨ç¤º UTC+1
    flags: u8,          // ä½æ ‡å¿—ï¼šæ˜¯å¦ DST / æ˜¯å¦æ ‡å‡†æ—¶é—´æŒ‡ç¤º / æ˜¯å¦ UT æŒ‡ç¤º
    name_data: [6:0]u8, // ä»¥ null ç»“å°¾çš„æ—¶åŒºåï¼Œæœ€å¤š6å­—ç¬¦ï¼ˆå¦‚ "CET"ï¼‰
};
```

#### æ–¹æ³•è¯´æ˜ï¼š
- `name()`: è¿”å›å­—ç¬¦ä¸²åˆ‡ç‰‡ï¼ˆnull-terminated sliceï¼‰ï¼Œè·å–æ—¶åŒºåã€‚
- `isDst()`: åˆ¤æ–­æ˜¯å¦ä¸ºå¤ä»¤æ—¶ï¼ˆæ£€æŸ¥æœ€ä½ä½ï¼‰ã€‚
- `standardTimeIndicator()`: æ˜¯å¦ä½œä¸ºâ€œæ ‡å‡†æ—¶é—´â€å¤„ç†ï¼ˆflag & 0x02ï¼‰ã€‚
- `utIndicator()`: æ˜¯å¦ç›´æ¥å¯¹åº” UT æ—¶é—´ï¼ˆflag & 0x04ï¼‰ã€‚

> âš ï¸ æ³¨ï¼š`flags` ä¸­çš„ä¸‰ä½åˆ†åˆ«ä»£è¡¨ï¼š
> - bit 0: isdstï¼ˆæ˜¯å¦å¤ä»¤æ—¶ï¼‰
> - bit 1: isstdï¼ˆæ˜¯å¦åº”è§†ä¸ºæ ‡å‡†æ—¶é—´ï¼‰
> - bit 2: isutï¼ˆæ˜¯å¦åº”è§†ä¸º UT æ—¶é—´ï¼‰

---

### 3. `Leapsecond` - é˜ˆå€¼ç§’ï¼ˆé—°ç§’ï¼‰ä¿¡æ¯
```zig
pub const Leapsecond = struct {
    occurrence: i48,   // å‘ç”Ÿæ—¶é—´ï¼ˆUTC æ—¶é—´æˆ³ï¼‰
    correction: i16,   // ç´¯è®¡è°ƒæ•´å€¼ï¼ˆ+1 è¡¨ç¤ºåŠ ä¸€ç§’ï¼‰
};
```
> ç”¨äºé«˜ç²¾åº¦æ—¶é—´è®¡ç®—ã€‚æ¯”å¦‚åœ¨ 2012 å¹´ 6 æœˆ 30 æ—¥æœ«å°¾æ’å…¥ä¸€ä¸ªé¢å¤–çš„ 23:59:60ã€‚

---

### 4. `Header` - TZif æ–‡ä»¶å¤´ï¼ˆextern structï¼‰

```zig
const Header = extern struct {
    magic: [4]u8,       // å¿…é¡»æ˜¯ "TZif"
    version: u8,        // ç‰ˆæœ¬ '0', '2', '3' ï¼ˆASCII å­—ç¬¦ï¼‰
    reserved: [15]u8,   // ä¿ç•™å­—æ®µ
    counts: extern struct {
        isutcnt: u32,   // UT/local indicator æ•°é‡
        isstdcnt: u32,  // standard/wall indicator æ•°é‡
        leapcnt: u32,   // é—°ç§’æ¡ç›®æ•°é‡
        timecnt: u32,   // transition æ•°é‡
        typecnt: u32,   // timetype ç±»å‹æ•°é‡
        charcnt: u32,   // æ—¶åŒºåæ€»é•¿åº¦ï¼ˆå«ç»“å°¾ \0ï¼‰
    },
}
```

> æ³¨æ„ï¼š`version == 0` ä½¿ç”¨æ—§ç‰ˆæ—¶é—´æˆ³ï¼ˆ32ä½ï¼‰ï¼Œ`version >= '2'` æ”¯æŒ 64 ä½æ—¶é—´æˆ³ã€‚

---

## ğŸ› ï¸ æ ¸å¿ƒå‡½æ•°ï¼š`parse`

```zig
pub fn parse(allocator: Allocator, reader: *Reader) !Tz
```

ä½œç”¨ï¼šè¯»å–ä¸€ä¸ª TZif æµå¹¶è§£ææˆå†…å­˜ä¸­çš„ `Tz` å¯¹è±¡ã€‚

### è§£ææµç¨‹å¦‚ä¸‹ï¼š

### âœ… ç¬¬ä¸€æ­¥ï¼šè¯»å–å¤´éƒ¨
```zig
const legacy_header = try reader.takeStruct(Header, .big);
```
- æ£€æŸ¥é­”æ•° `"TZif"`
- æ£€æŸ¥ç‰ˆæœ¬å·åˆæ³•æ€§ï¼šåªèƒ½æ˜¯ `0`, `'2'`, `'3'`

### ğŸ”„ å¤„ç†åŒå—ç»“æ„ï¼ˆLegacy + Modernï¼‰
TZif å…¼å®¹æ€§è®¾è®¡å…è®¸åŒæ—¶åŒ…å«ä¸¤ä¸ªç‰ˆæœ¬çš„æ•°æ®å—ï¼š

| Version | Time Type Size |
|--------|----------------|
| v=0    | 32-bit timestamps |
| v=2/3  | 64-bit timestamps |

#### å¦‚æœç‰ˆæœ¬ä¸æ˜¯ 0ï¼š
- è·³è¿‡æ•´ä¸ª legacy blockï¼ˆå› ä¸ºåé¢è¿˜æœ‰æ›´å®Œæ•´çš„ç°ä»£ç‰ˆæœ¬ï¼‰
- å†è¯»ä¸€æ¬¡ headerï¼ˆmodern ç‰ˆæœ¬ï¼‰
- ç„¶åè°ƒç”¨ `parseBlock` è§£æ modern æ•°æ®

å¦åˆ™ç›´æ¥è§£æ legacy æ•°æ®ã€‚

---

## ğŸ§© `parseBlock` å‡½æ•°è¯¦è§£

è¿™æ˜¯çœŸæ­£è§£ææ•°æ®çš„æ ¸å¿ƒå‡½æ•°ã€‚

### æ­¥éª¤ä¸€ï¼šåŸºæœ¬æ ¡éªŒï¼ˆç¬¦åˆ RFC 8536ï¼‰
```zig
if (header.counts.isstdcnt != 0 and header.counts.isstdcnt != header.counts.typecnt)
    return error.Malformed;
// åŒæ ·æ£€æŸ¥ isutcnt
if (header.counts.typecnt == 0 || header.counts.charcnt == 0)
    return error.Malformed;
```

> ç¬¦åˆ RFC è§„å®šï¼š`isstdcnt` å’Œ `isutcnt` è¦ä¹ˆä¸º 0ï¼Œè¦ä¹ˆç­‰äº `typecnt`

---

### æ­¥éª¤äºŒï¼šåˆ†é…å†…å­˜
```zig
var leapseconds = try allocator.alloc(Leapsecond, header.counts.leapcnt);
var transitions = try allocator.alloc(Transition, header.counts.timecnt);
var timetypes = try allocator.alloc(Timetype, header.counts.typecnt);
```
ä½¿ç”¨ `errdefer` ç¡®ä¿å‡ºé”™æ—¶è‡ªåŠ¨é‡Šæ”¾å·²åˆ†é…èµ„æºã€‚

---

### æ­¥éª¤ä¸‰ï¼šè§£æ Transition æ—¶é—´ç‚¹
```zig
while (i < timecnt) {
    transitions[i].ts = if (legacy) read i32 else read i64; // å¤§ç«¯åº
}
```

æ¥ç€è¯»å–æ¯ä¸ª transition æ‰€å±çš„ `timetype` ç´¢å¼•ï¼ˆå­—èŠ‚ï¼‰ï¼Œå¹¶è®¾ç½®æŒ‡é’ˆã€‚

---

### æ­¥éª¤å››ï¼šè§£æ Timetype æ¡ç›®
æ¯é¡¹åŒ…æ‹¬ï¼š
- `offset`: i32ï¼ˆæ³¨æ„ä¸èƒ½æ˜¯ -2^31ï¼‰
- `isdst`: u8ï¼ˆå¿…é¡»æ˜¯ 0 æˆ– 1ï¼‰
- `idx`: åç§°åœ¨åç»­å­—ç¬¦ä¸²æ± ä¸­çš„èµ·å§‹ç´¢å¼•

ä¸´æ—¶å°† `idx` å­˜å…¥ `name_data[0]`ï¼Œç¨åå¡«å……å®é™…åå­—ã€‚

---

### æ­¥éª¤äº”ï¼šè¯»å– Designator Stringsï¼ˆæ—¶åŒºåå­—ç¬¦ä¸²æ± ï¼‰
```zig
try reader.readSliceAll(designators_data[0..charcnt]);
```
æ‰€æœ‰æ—¶åŒºåè¿æ¥åœ¨ä¸€èµ·ï¼Œä»¥ `\0` åˆ†éš”ï¼Œæœ«å°¾å¿…é¡»æ˜¯ `\0`ã€‚

ç„¶åéå† `timetypes`ï¼Œæ ¹æ® `idx` æå–å¯¹åº”çš„åå­—ï¼Œå¤åˆ¶è¿› `name_data`ï¼Œé™åˆ¶é•¿åº¦ â‰¤6 å­—ç¬¦ï¼ˆPOSIX è¦æ±‚ï¼‰ã€‚

---

### æ­¥éª¤å…­ï¼šè§£æ Leap Seconds
```zig
occur: i64 (æˆ– i32)ï¼Œcorr: i32 â†’ å­˜ä¸º i48/i16
```

ä¸¥æ ¼éªŒè¯ï¼š
- ç¬¬ä¸€æ¡ corr å¿…é¡»æ˜¯ Â±1
- ç›¸é‚» corr å·®å€¼å¿…é¡»ä¸º Â±1
- occur é€’å¢ä¸”é—´éš” â‰¥2419199 ç§’ï¼ˆçº¦ 27.5 å¤©ï¼Ÿå…¶å®æ˜¯é˜²æ­¢å†²çªï¼‰

> å®é™…ä¸Š RFC è§„å®šæ¯æ¬¡ leap second è‡³å°‘ç›¸éš”å‡ å¤©ï¼Œè¿™é‡Œç¡®ä¿ä¸ä¼šå¯†é›†å‡ºç°ã€‚

---

### æ­¥éª¤ä¸ƒï¼šè§£æ isstd å’Œ isut æŒ‡ç¤ºå™¨
è¯»å– `isstdcnt` ä¸ªå­—èŠ‚ï¼Œè‹¥ä¸º 1ï¼Œåˆ™å¯¹åº” `timetypes[i]` è®¾ç½® flag |= 0x02  
åŒç† `isutcnt` â†’ flag |= 0x04

å¹¶ä¸”è¦æ±‚ï¼šå¦‚æœ `isut` ä¸ºçœŸï¼Œåˆ™ `isstd` ä¹Ÿå¿…é¡»ä¸ºçœŸï¼ˆRFC å¼ºåˆ¶ï¼‰

---

### æ­¥éª¤å…«ï¼šè§£æ Footerï¼ˆä»…é€‚ç”¨äº v2/v3ï¼‰
- å¿…é¡»ä»¥ `\n` å¼€å¤´
- åç»­æ˜¯ä¸€æ®µå¯é€‰çš„ POSIX TZ é£æ ¼å­—ç¬¦ä¸²ï¼ˆå¦‚ `<UTC+8>-8`ï¼‰
- æœ€å¤§è¯»å– 128 å­—èŠ‚ï¼ˆé˜²æ»¥ç”¨ï¼‰

ä¿å­˜ä¸º `footer` å­—æ®µï¼Œå¯ç”¨äºæœªæ¥æ ¼å¼å›é€€æˆ–è°ƒè¯•ã€‚

---

## ğŸ§¹ æ¸…ç†å‡½æ•°ï¼š`deinit`

```zig
pub fn deinit(self: *Tz) void {
    // ä¾æ¬¡é‡Šæ”¾æ‰€æœ‰åŠ¨æ€åˆ†é…çš„æ•°ç»„
}
```

æ‰‹åŠ¨ç®¡ç†å†…å­˜ï¼Œé¿å…æ³„æ¼ã€‚

---

## âœ… å•å…ƒæµ‹è¯•

æä¾›äº†ä¸‰ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–ä¸åŒæƒ…å†µï¼š

### 1. `test "slim"` â€“ Asia/Tokyo
- ä½¿ç”¨ç°ä»£æ ¼å¼ï¼ˆv2ï¼‰
- åŒ…å« DST è½¬æ¢å’Œé—°ç§’
- æ–­è¨€å…·ä½“æ—¶é—´ç‚¹å’Œåç§°æ­£ç¡®

### 2. `test "fat"` â€“ Antarctica/Davis
- æåœ°å¤æ‚æ—¶åŒº
- éªŒè¯è¿‡æ¸¡æ—¶é—´å’Œåç§»é‡

### 3. `test "legacy"` â€“ Europe/Vaticanï¼ˆSlackware 8.0ï¼‰
- ä½¿ç”¨ v0 æ ¼å¼ï¼ˆ32ä½æ—¶é—´æˆ³ï¼‰
- åŒ…å«å¤§é‡å†å²è½¬æ¢ï¼ˆ170æ¬¡ï¼‰
- éªŒè¯è€ç³»ç»Ÿå…¼å®¹æ€§

è¿™äº›æµ‹è¯•ä¿è¯äº†è§£æå™¨èƒ½å¤„ç†çœŸå®ä¸–ç•Œçš„å„ç§ TZif æ–‡ä»¶ã€‚

---

## ğŸ“Œ æ€»ç»“ï¼šåŠŸèƒ½äº®ç‚¹

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| âœ… å®Œå…¨ç¬¦åˆ RFC 8536 | åŒ…æ‹¬å­—æ®µæ ¡éªŒã€è¾¹ç•Œæ£€æŸ¥ |
| âœ… æ”¯æŒå¤šç‰ˆæœ¬ï¼ˆv0/v2/v3ï¼‰ | è‡ªåŠ¨è·³è¿‡ legacy block |
| âœ… å†…å­˜å®‰å…¨ | ä½¿ç”¨ `errdefer` é˜²æ­¢æ³„æ¼ |
| âœ… é«˜æ•ˆç´§å‡‘ | å°† name å›ºå®šä¸º 6+1 å­—èŠ‚ï¼Œä¾¿äºåµŒå…¥ |
| âœ… æ”¯æŒ Leap Second | ç”¨äºé«˜ç²¾åº¦æ—¶é—´ç³»ç»Ÿ |
| âœ… æä¾› Footer è§£æ | è·å– POSIX TZ å­—ç¬¦ä¸²å¤‡ç”¨ |

---

## ğŸ›‘ æ½œåœ¨æ”¹è¿›ç‚¹ï¼ˆå»ºè®®ï¼‰

1. **é”™è¯¯ä¿¡æ¯ä¸å¤Ÿä¸°å¯Œ**  
   å½“å‰è¿”å› `error.Malformed` è¿‡äºç¬¼ç»Ÿï¼Œå¯ç»†åŒ–é”™è¯¯ç ä»¥ä¾¿è°ƒè¯•ã€‚

2. **ç¼ºä¹æŸ¥æ‰¾ API**  
   è§£æå®Œä¹‹åæ²¡æœ‰æä¾›â€œç»™å®šæ—¶é—´è¿”å›å¯¹åº”æ—¶åŒºåç§»â€çš„æ–¹æ³•ï¼ˆä½†å¯èƒ½æ˜¯æ›´é«˜å±‚çš„åŠŸèƒ½ï¼‰ã€‚

3. **æœªå¤„ç† v3 ç‰¹æ€§ï¼ˆçº³ç§’ç²¾åº¦ï¼‰**  
   RFC 8536 æåˆ° v3 æ”¯æŒçº³ç§’æ‰©å±•ï¼Œæ­¤ä»£ç æœªä½“ç°ï¼ˆå¯èƒ½ä¾èµ–å¤–éƒ¨å·¥å…·é“¾ï¼‰ã€‚

4. **footer æˆªæ–­é£é™©**  
   `StreamTooLong` é”™è¯¯ä¼šä¸­æ–­è¯»å–ï¼Œä½†æŸäº›åˆæ³• TZ å­—ç¬¦ä¸²å¯èƒ½æ¥è¿‘æé™ã€‚

---

## ğŸ“ ç¤ºä¾‹ç”¨é€”

ä½ å¯ä»¥è¿™æ ·ä½¿ç”¨è¿™ä¸ªæ¨¡å—æ¥åˆ†ææŸä¸ªåŸå¸‚çš„æ—¶åŒºè¡Œä¸ºï¼š

```zig
const tz = try std.Tz.parse(allocator, file_reader);
for (tz.transitions) |trans| {
    std.debug.print("{} -> {} ({})\n", .{
        trans.ts,
        trans.timetype.offset / 3600,
        trans.timetype.name()
    });
}
```

è¾“å‡ºç±»ä¼¼ï¼š
```
-620298000 -> 9 (JDT)
...
```

---

âœ… **æ€»ç»“ä¸€å¥è¯ï¼š**
> è¿™æ˜¯ä¸€ä¸ªé«˜æ•ˆã€åˆè§„ã€å¥å£®çš„ Zig å®ç°ï¼Œç”¨äºè§£æ Unix æ—¶åŒºæ•°æ®åº“ä¸­çš„ `.tzif` äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé€‚åˆæ„å»ºè·¨å¹³å°æ—¶é—´åº“æˆ–ç³»ç»Ÿçº§æ—¶é—´å¤„ç†ç»„ä»¶ã€‚